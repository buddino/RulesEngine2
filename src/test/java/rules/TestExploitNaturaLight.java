package rules;

import it.cnit.gaia.rulesengine.model.exceptions.RuleInitializationException;
import it.cnit.gaia.rulesengine.rules.ExploitNaturalLight;
import it.cnit.gaia.rulesengine.utils.MeasurementsUtils;
import org.junit.Before;
import org.junit.Rule;
import org.junit.Test;
import org.junit.jupiter.api.Assertions;
import org.junit.rules.ExpectedException;
import org.mockito.MockitoAnnotations;

import static org.mockito.Mockito.when;

public class TestExploitNaturaLight extends GenericRuleTest{
	@Rule
	public ExpectedException thrown = ExpectedException.none();

	ExploitNaturalLight rule;


	@Before
	public void setUp() throws RuleInitializationException {
		MockitoAnnotations.initMocks(this);
		rule = new ExploitNaturalLight();
		setUpRule(rule);
	}

	@Test
	public void testValidInit() throws RuleInitializationException {
		rule.luminosity_uri = "luminosity";
		rule.power_uri = "power";
		rule.power_threshold = 0.6E6;
		rule.luminosity_threshold = 500.0;
		Assertions.assertTrue(rule.init());
	}
	@Test
	public void testNotValidInit1() throws RuleInitializationException {
		thrown.expect(RuleInitializationException.class);
		rule.luminosity_uri = "luminosity";
		rule.power_uri = "power";
		rule.power_threshold = 0.6E6;
		//rule.luminosity_threshold = 500.0;
		rule.init();
	}
	@Test
	public void testNotValidInit2() throws RuleInitializationException {
		thrown.expect(RuleInitializationException.class);
		//rule.luminosity_uri = "luminosity";
		rule.power_uri = "power";
		rule.power_threshold = 0.6E6;
		rule.luminosity_threshold = 500.0;
		rule.init();
	}
	@Test
	public void testNotValidInit3() throws RuleInitializationException {
		thrown.expect(RuleInitializationException.class);
		rule.luminosity_uri = "luminosity";
		//rule.power_uri = "power";
		rule.power_threshold = 0.6E6;
		rule.luminosity_threshold = 500.0;
		rule.init();
	}
	@Test
	public void testNotValidInit4() throws RuleInitializationException {
		thrown.expect(RuleInitializationException.class);
		rule.luminosity_uri = "luminosity";
		rule.power_uri = "power";
		//rule.power_threshold = 0.6E6;
		rule.luminosity_threshold = 500.0;
		rule.init();
	}

	@Test
	public void testOverThreshold() throws RuleInitializationException {
		when(measurementRepository.getLatestFor("luminosity")).thenReturn(MeasurementsUtils.getResourceDTO(600.0));
		when(measurementRepository.getLatestFor("power")).thenReturn(MeasurementsUtils.getResourceDTO(1.0E6));
		rule.luminosity_uri = "luminosity";
		rule.power_uri = "power";
		rule.power_threshold = 0.6E6;
		rule.luminosity_threshold = 500.0;
		rule.init();
		Assertions.assertTrue(rule.condition());
	}
}
